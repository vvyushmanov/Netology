## Установка стека Clickhouse + Vector

### Установка Clickhouse

#### Основной блок

1. Имя play - Install Clickhouse
2. Хосты: все (будет установлено на все хосты, перечисленные в инвентаре)
3. Тэги:  `clickhouse`, `full` (можно запустить плэйбук с тэгом `clickhouse`, установится только он)
4. Хэндлеры (выполнятся по завершению всех тасок либо если "дёрнуть" `flush handlers`)
    * Используется плагин `service`, чтобы запустить `systemd` сервис кликхауса

#### Таски

1. Скачивание дистрибутивов кликхауса, с указанием версии, прописанной в `vars`
    * С помощью `with_items` выполняется в цикле, чтобы скачать клиент, сервер и общий пакет
2. Установка пакетов кликхауса с помощью модуля `yum`
    * После установки выполняется оповещение хендлера перезапуска
3. Принудительное выполнение хендлера, с целью запустить сервис в этой точке плэйбука
4. Создание базы данных кликхауса с помощью консольной команды (модуль `command`)
    * Запись результата выполнения команды (exit code) в переменную `create_db`.
    * Если код выхода не 0 и не 82, считать шаг `failed`, если код 0 - `changed`

### Установка Vector

#### Основной блок

1. Имя play - Install Vector
2. Хосты: все (будет установлено на все хосты, перечисленные в инвентаре)
3. Тэги:  `vector`, `full` (можно запустить плэйбук с тэгом vector, установится только он)
4. Хэндлеры (выполнятся по завершению всех тасок либо если "дёрнуть" `flush handlers`)
    * Используется плагин `service`, чтобы запустить `systemd` сервис вектора

#### Таски

1. Создание сервис-юзера `vector`, под которым будет работать сервис
2. Создание директории `vector`, в которую будет выполнена установка
    * Директория создаётся по пути `/home/vector/vector`, заданному в переменной `home`
    * Создаётся от пользователя `vector`
3. Скачивание архива с дистрибутивом вектора
4. Распаковка дистрибутива 
    * Параметр `strip-components` позволяет убрать "промежуточную" директорию верхнего уровня, находящуюся в архиве
    * Указаны абсолютные пути, т.к. с относительными модуль выдаёт ошибку
5. Начало блока уставки. Создание симлинка для исполняемого файла
    * Выполняется от `root`
    * Симлинк помещается в директорию `/usr/bin` и ссылается на файл, расположенный в `~/vector/bin`
6. Создание `data` директории
    * Выполняется от `root`
    * Согласно мануалу, дата-директория размещается в `/var/lib/vector`
    * Права на директорию выдаются пользователю `vector`
7. Создание конфигурационной директории в директории `/etc`
    * Путь: `/etc/vector`
8. Cоздание симлинка для файла конфигурации
    * Файл расположен в `~/vector/config`
9. Добавление сервиса в `systemd`
    * Образец сервис-файла прилагается к архиву, расположен в `~/vector/etc`
    * С помощью модуля `file`, с правами `root`, копируется в `/etc/systemd/system`
    * Оповещается хендлер, стартующий сервис